flowchart TB
  %% External Actor
  U[User / Client Apps (Web, Mobile, Postman)]:::ext -->|HTTPS + JWT| G[API Endpoints (Spring MVC Controllers)]:::proc

  %% Cross-cutting (inside app)
  subgraph X[Cross-cutting Concerns (in-app)]
    TF[TracingFilter - JWT validate, UserContext, MDC traceId/spanId]:::cross
    UCR[UserContextResolver (Controller arg resolver)]:::cross
    EXH[GlobalExceptionHandler (ApplicationException → GenericResponse)]:::cross
    LOG[SLF4J + MDC]:::cross
    VAL[Jakarta Validation]:::cross
  end

  U -->|requests pass through| TF --> G
  TF --> UCR --> G
  G -->|@Valid DTOs| VAL
  G --> SVC[Service Layer (Business Orchestration)]:::proc

  %% Mapping & Transformations
  subgraph M[Mapping & Composition]
    MAP[MapStruct Mappers (Agent/Customer/User/MZ Mapping)]:::proc
    TR[Response Transformer (ResponseBuilder → GenericResponse)]:::proc
  end
  G <-->|DTOs⇄Domain| MAP
  SVC <-->|Domain⇄DTO| MAP
  SVC --> TR

  %% Data Access
  subgraph D[Persistence]
    REP[Repository Interfaces (MyBatis @Mapper)]:::proc
    XML[(MyBatis XML Mappers - resources/mappers)]:::store
    DB[(MySQL)]:::store
  end
  SVC --> REP
  REP --> XML --> DB

  %% External Integrations via Feign
  subgraph E[External Systems]
    FEI[OpenFeign Clients (OnboardingClient, PlantInfoClient)]:::proc
    CM[(CM Onboarding API)]:::ext
    PL[(Plant Info API)]:::ext
  end
  SVC --> FEI
  FEI --> CM
  FEI --> PL

  %% Spring Cloud Runtime (optional)
  subgraph C[Spring Cloud (optional)]
    CFG[(Config Server Client)]:::cloud
    EUR[(Eureka Client)]:::cloud
    LB[(Spring Cloud LoadBalancer)]:::cloud
  end

  APP[Azam CRM Service - Spring Boot 3, Java 21]:::app
  APP --- C
  AP
