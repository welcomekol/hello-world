flowchart TB
  U["User / Client Apps (Web, Mobile, Postman)"]:::ext --> G["API Endpoints (Spring MVC Controllers)"]:::proc

  %% Cross-cutting Concerns
  TF["TracingFilter - JWT validate, UserContext, MDC traceId/spanId"]:::cross
  UCR["UserContextResolver (Controller arg resolver)"]:::cross
  EXH["GlobalExceptionHandler (ApplicationException → GenericResponse)"]:::cross
  LOG["SLF4J + MDC"]:::cross
  VAL["Jakarta Validation"]:::cross

  U --> TF
  TF --> UCR
  UCR --> G
  G --> VAL
  G --> SVC["Service Layer (Business Orchestration)"]:::proc

  %% Mapping
  MAP["MapStruct Mappers (Agent/Customer/User/MZ Mapping)"]:::proc
  TR["Response Transformer (ResponseBuilder → GenericResponse)"]:::proc
  G --> MAP
  SVC --> MAP
  SVC --> TR

  %% Persistence
  REP["Repository Interfaces (MyBatis @Mapper)"]:::proc
  XML["MyBatis XML Mappers (resources/mappers)"]:::store
  DB["MySQL Database"]:::store
  SVC --> REP
  REP --> XML
  XML --> DB

  %% External Systems
  FEI["OpenFeign Clients (OnboardingClient, PlantInfoClient)"]:::proc
  CM["CM Onboarding API"]:::ext
  PL["Plant Info API"]:::ext
  SVC --> FEI
  FEI --> CM
  FEI --> PL

  %% Spring Cloud
  CFG["Config Server Client"]:::cloud
  EUR["Eureka Client"]:::cloud
  LB["Spring Cloud LoadBalancer"]:::cloud

  APP["Azam CRM Service - Spring Boot 3, Java 21"]:::app
  APP --- CFG
  APP --- EUR
  APP --- LB
  APP --- TF
  APP --- UCR
  APP --- EXH
  APP --- LOG
  APP --- VAL
  APP --- MAP
  APP --- TR
  APP --- REP
  APP --- XML
  APP --- DB
  APP --- FEI
  APP --- CM
  APP --- PL

  %% Styles
  classDef ext fill:#eef,stroke:#446,font-weight:bold
  classDef store fill:#ffe,stroke:#aa6
  classDef proc fill:#e8fff1,stroke:#484
  classDef cross fill:#fef,stroke:#a4a
  classDef cloud fill:#eef7ff,stroke:#57a
  classDef app fill:#fff,stroke:#000,stroke-width:2px
